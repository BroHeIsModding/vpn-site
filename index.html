<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VPN Discord Verification</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* (CSS styles would be here: music player, dark/light toggle, gradient background, etc.) */
</style>
</head>
<body>

<nav>
  <a href="https://discord.gg/vpn" target="_blank">Join Bxrty's Gaming VPN Server!</a>
  <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
</nav>

<div class="main-container">
  <div class="captcha-box">
    <h2>VPN Discord Verification</h2>
    <a id="discordLoginButton" class="theme-toggle" href="#">Login with Discord</a>
    <input type="hidden" id="discordIdInput">
    <br><br>
    <select id="playlistSelector" onchange="changePlaylist()">
      <option value="shoegaze">Shoegaze/Grungaze</option>
      <option value="hardcore">Hardcore</option>
      <option value="lofi">Lofi</option>
      <option value="rap">Rap</option>
      <option value="jazz">Jazz</option>
    </select>
    <div id="nowPlaying">Now Playing: Shoegaze/Grungaze</div>
  </div>
</div>

<div class="music-player" id="musicPlayer">
  <div class="album-art" id="albumArt">
    <img id="albumImage" src="" alt="Album Art">
  </div>
  <div class="music-title" id="musicTitle">Loading...</div>
  <div class="music-controls">
    <button onclick="playMusic()">Play</button>
    <button onclick="pauseMusic()">Pause</button>
    <button onclick="nextMusic()">Next</button>
  </div>
  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
</div>

<div class="slider-container">
  <input type="range" id="hueSlider" min="0" max="360" value="0" onchange="changeHue()">
</div>

<div id="player"></div>

<script>
// SETTINGS
const clientId = '1283074346918744175';
const redirectUri = 'https://broheismodding.github.io/vpn-site/';
const backendUrl = 'https://vpn-backend-plum.vercel.app';
const verifyWebhook = 'https://api.botghost.com/webhook/1283074346918744175/zo58m0hhd0qfb0ruenl98t';
const playlists = {
  hardcore: 'PLMJGV7p_FGBWtBoWNYv2H1508z3gyEYLS',
  shoegaze: 'PLzXFVyVdaUThF4H6qdtJBQw7iVYmULpi0',
  lofi: 'PLfsYQtR1st_XD3VBVZc77BabITQddjMpe',
  rap: 'PLIwZQxuoolfoQX3G6v55ThCQDKaLnQusI',
  jazz: 'PLneA0BedPWJEvDseXizycnviRmoHMci91'
};
let currentPlaylist = 'shoegaze';

let darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
const storedTheme = localStorage.getItem('theme');
if (storedTheme) darkMode = storedTheme === 'dark';
function applyTheme() { document.body.classList.toggle('dark-mode', darkMode); changeHue(); localStorage.setItem('theme', darkMode ? 'dark' : 'light'); }
function toggleTheme() { darkMode = !darkMode; applyTheme(); }
applyTheme();

// Redirect to Discord Login
function redirectToDiscord() {
  const oauthUrl = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=identify`;
  window.location.href = oauthUrl;
}
document.getElementById('discordLoginButton').onclick = redirectToDiscord;

// OAuth2 Flow
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');

if (code) {
  fetch(`${backendUrl}/api/oauth/callback?code=${code}`)
    .then(res => res.json())
    .then(data => {
      // 🧹 CLEAN URL Immediately
      window.history.replaceState({}, document.title, redirectUri);

      if (data.error) {
        console.error('OAuth Error:', data.error);
        alert('❌ Discord login failed.');
        return;
      }

      console.log('Access Token:', data.access_token);

      fetch(`${backendUrl}/api/userinfo?access_token=${data.access_token}`)
        .then(res => res.json())
        .then(userData => {
          if (userData.id) {
            console.log('Discord User ID:', userData.id);
            document.getElementById('discordIdInput').value = userData.id;
            fetch(verifyWebhook, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ discord_id: userData.id, verified: true })
            }).then(() => {
              alert('✅ You have been verified!');
            }).catch(() => {
              alert('❌ Error sending verification webhook.');
            });
          } else {
            alert('❌ Failed to fetch Discord user info.');
          }
        }).catch(() => {
          alert('❌ Failed to fetch user info.');
        });
    })
    .catch(() => {
      alert('❌ Error during OAuth2 flow.');
    });
}

// Background Color Changer
function changeHue() {
  const hue = document.getElementById("hueSlider").value;
  if (darkMode) {
    document.body.style.background = `linear-gradient(270deg, hsl(${hue}, 20%, 15%), hsl(${(parseInt(hue)+30)%360}, 20%, 15%), hsl(${(parseInt(hue)+60)%360}, 20%, 15%))`;
  } else {
    document.body.style.background = `linear-gradient(270deg, hsl(${hue}, 30%, 85%), hsl(${(parseInt(hue)+50)%360}, 30%, 85%), hsl(${(parseInt(hue)+100)%360}, 30%, 85%))`;
  }
}

// YouTube Music Player Setup
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

let player;
function onYouTubeIframeAPIReady() {
  loadPlaylist(playlists[currentPlaylist]);
}
function loadPlaylist(listId) {
  if (player) player.destroy();
  player = new YT.Player('player', {
    height: '0',
    width: '0',
    playerVars: { listType: 'playlist', list: listId },
    events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
  });
}
function onPlayerReady(event) {
  event.target.setVolume(50);
  playMusic();
}
function onPlayerStateChange(event) {
  if (event.data == YT.PlayerState.PLAYING) {
    document.getElementById('albumArt').classList.add('spin');
  } else {
    document.getElementById('albumArt').classList.remove('spin');
  }
  updateTitleAndImage();
}
function playMusic() { if (player) player.playVideo(); }
function pauseMusic() { if (player) player.pauseVideo(); }
function nextMusic() { if (player) player.nextVideo(); }
function updateTitleAndImage() {
  if (!player || !player.getVideoData) return;
  const data = player.getVideoData();
  document.getElementById('musicTitle').innerText = data.title || 'Loading...';
  if (data.video_id) {
    document.getElementById('albumImage').src = `https://img.youtube.com/vi/${data.video_id}/hqdefault.jpg`;
  }
}
setInterval(() => {
  if (player && player.getDuration) {
    const progress = (player.getCurrentTime() / player.getDuration()) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
  }
}, 500);

// Playlist Changer
function changePlaylist() {
  const selector = document.getElementById('playlistSelector');
  currentPlaylist = selector.value;
  document.getElementById('nowPlaying').innerText = `Now Playing: ${selector.options[selector.selectedIndex].text}`;
  loadPlaylist(playlists[currentPlaylist]);
}
</script>


</body>
</html>
